name: Transmitir

on:
  workflow_dispatch:
    inputs:
      artefato_url:
        description: 'URL do artefato (API)'
        required: true

jobs:
  baixar_e_transmitir:
    runs-on: ubuntu-latest

    steps:
      - name: 🔁 Clonar repositório
        uses: actions/checkout@v4

      - name: 📥 Baixando artefato zipado via API
        run: |
          echo "🔗 Baixando artefato de: ${{ github.event.inputs.artefato_url }}"
          curl -L \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            -H "Accept: application/zip" \
            "${{ github.event.inputs.artefato_url }}" \
            -o artefato.zip

      - name: 📦 Descompactar artefato
        run: |
          mkdir -p artefatos/video_final
          unzip artefato.zip -d artefatos/video_final || {
            echo "❌ Erro ao descompactar. Verifique se o link é válido ou se o artefato expirou."
            exit 1
          }

      - name: 📂 Listar conteúdo do artefato
        run: |
          echo "📁 Conteúdo extraído:"
          find artefatos/video_final -type f

      - name: 🧰 Instalar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: 🎬 Instalar FFmpeg
        run: |
          sudo apt update
          sudo apt install -y ffmpeg

      - name: 📦 Inicializar projeto Node e instalar dependências
        working-directory: artefatos/video_final
        run: |
          echo '{}' > package.json
          npm install

      - name: 🚀 Iniciar Transmissão com transmitir.js
        run: |
          echo "🚀 Iniciando transmissão com transmitir.js..."
          node artefatos/video_final/transmitir.js

      - name: 🧹 Deletar artefato remoto após transmissão
        run: |
          echo "🧹 Excluindo artefato remoto..."

          # Extrai o ID da URL
          ARTEFATO_URL="${{ github.event.inputs.artefato_url }}"
          ARTEFATO_ID=$(echo "$ARTEFATO_URL" | sed -E 's|.*/artifacts/([0-9]+)/zip|\1|')

          echo "🔍 Artefato ID extraído: $ARTEFATO_ID"

          curl -X DELETE \
            -H "Authorization: Bearer ${{ secrets.LIVE_PAT }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/Miraplay2025/Live/actions/artifacts/$ARTEFATO_ID \
          && echo "✅ Artefato $ARTEFATO_ID excluído com sucesso." \
          || echo "⚠️ Falha ao excluir artefato $ARTEFATO_ID"
