name: Transmitir

on:
  workflow_dispatch:
    inputs:
      artefato_url:
        description: 'URL do artefato (API)'
        required: true

jobs:
  baixar_e_transmitir:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ” Clonar repositÃ³rio
        uses: actions/checkout@v4

      - name: ğŸ§  Corrigir URL se necessÃ¡rio
        id: corrigir
        run: |
          INPUT_URL="${{ github.event.inputs.artefato_url }}"
          if [[ "$INPUT_URL" == https://github.com/* ]]; then
            CORRIGIDA=$(echo "$INPUT_URL" | sed 's|https://github.com/|https://api.github.com/repos/|' | sed 's|/actions/artifacts/|/actions/artifacts/|' | sed 's|/zip||')
            echo "ğŸ” URL corrigida para: $CORRIGIDA"
          else
            CORRIGIDA="$INPUT_URL"
          fi
          echo "url_corrigida=$CORRIGIDA" >> "$GITHUB_OUTPUT"

      - name: ğŸ“¥ Baixando artefato zipado via API
        run: |
          echo "ğŸ”— Baixando artefato de: ${{ steps.corrigir.outputs.url_corrigida }}"
          curl -L \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/zip" \
            "${{ steps.corrigir.outputs.url_corrigida }}" \
            -o artefato.zip

      - name: ğŸ“¦ Descompactar artefato
        run: |
          mkdir -p artefatos/video_final
          unzip artefato.zip -d artefatos/video_final || {
            echo "âŒ Erro ao descompactar. Verifique se o link Ã© vÃ¡lido ou se o artefato expirou."
            exit 1
          }

      - name: ğŸ“‚ Listar conteÃºdo do artefato
        run: |
          echo "ğŸ“ ConteÃºdo extraÃ­do:"
          find artefatos/video_final -type f

      - name: ğŸ§° Instalar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ¬ Instalar FFmpeg
        run: |
          sudo apt update
          sudo apt install -y ffmpeg

      - name: ğŸš€ Iniciar TransmissÃ£o com transmitir.js
        run: |
          echo "ğŸš€ Iniciando transmissÃ£o com transmitir.js..."
          node transmitir.js

      - name: ğŸ§¹ Deletar artefato apÃ³s transmissÃ£o
        env:
          GH_TOKEN: ${{ secrets.LIVE_DELETE_TOKEN }}
        run: |
          echo "ğŸ§¼ Iniciando exclusÃ£o do artefato remoto..."
          artefato_id=$(echo "${{ steps.corrigir.outputs.url_corrigida }}" | grep -oP 'artifacts/\K[0-9]+')
          if [ -z "$artefato_id" ]; then
            echo "âŒ NÃ£o foi possÃ­vel extrair o ID do artefato. Abortando."
            exit 1
          fi
          echo "ğŸ†” ID do artefato: $artefato_id"

          curl -X DELETE \
            -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/Miraplay2025/Live/actions/artifacts/$artefato_id" || {
              echo "âŒ Falha ao deletar artefato."
              exit 1
          }

          echo "âœ… Artefato $artefato_id excluÃ­do com sucesso."
