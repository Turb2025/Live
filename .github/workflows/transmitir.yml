name: Transmitir

on:
  workflow_dispatch:
    inputs:
      artefato_url:
        description: 'URL do artefato (API ou GitHub)'
        required: true

jobs:
  baixar_e_transmitir:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ” Clonar repositÃ³rio
        uses: actions/checkout@v4

      - name: ğŸ› ï¸ Corrigir URL se necessÃ¡rio
        id: corrigir_url
        run: |
          URL="${{ github.event.inputs.artefato_url }}"
          if [[ "$URL" == https://github.com/* ]]; then
            echo "ğŸ”§ Corrigindo URL para formato da API..."
            API_URL=$(echo "$URL" | sed -E 's|https://github\.com/([^/]+)/([^/]+)/actions/runs/[0-9]+/artifacts/([0-9]+)|https://api.github.com/repos/\1/\2/actions/artifacts/\3/zip|')
            echo "url_corrigida=$API_URL" >> "$GITHUB_OUTPUT"
            echo "âœ… URL corrigida: $API_URL"
          else
            echo "âœ… URL jÃ¡ estÃ¡ no formato da API: $URL"
            echo "url_corrigida=$URL" >> "$GITHUB_OUTPUT"
          fi

      - name: ğŸ“¥ Baixar artefato zipado
        run: |
          URL="${{ steps.corrigir_url.outputs.url_corrigida }}"
          echo "ğŸ”— Baixando artefato de: $URL"
          curl -L \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            -H "Accept: application/zip" \
            "$URL" \
            -o artefato.zip

      - name: ğŸ“¦ Descompactar artefato corretamente
        run: |
          mkdir -p artefatos
          unzip artefato.zip -d artefatos || {
            echo "âŒ Erro ao descompactar. Verifique se o link Ã© vÃ¡lido ou se o artefato expirou."
            exit 1
          }

      - name: ğŸ“‚ Verificar estrutura do artefato
        run: |
          echo "ğŸ“ Estrutura final do artefato extraÃ­do:"
          find artefatos -type f

          echo "ğŸ§¾ Verificando arquivos essenciais:"
          for file in ts_paths.json stream_info.json; do
            if [[ -f "artefatos/$file" ]]; then
              echo "âœ… $file encontrado."
            else
              echo "âŒ $file NÃƒO encontrado!"
              exit 1
            fi
          done

      - name: ğŸ§° Instalar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: ğŸ¬ Instalar FFmpeg
        run: |
          sudo apt update
          sudo apt install -y ffmpeg

      - name: ğŸ“¦ Instalar dependÃªncias do projeto
        run: |
          echo '{}' > package.json
          npm install

      - name: ğŸš€ Iniciar TransmissÃ£o com transmitir.js
        id: transmitir
        run: |
          echo "ğŸš€ Transmitindo com transmitir.js..."
          node transmitir.js

      - name: ğŸ—‘ï¸ Excluir artefato apÃ³s transmissÃ£o bem-sucedida
        if: success() && steps.transmitir.outcome == 'success'
        env:
          PERSONAL_TOKEN: ${{ secrets.PERSONAL_TOKEN }}
        run: |
          URL="${{ steps.corrigir_url.outputs.url_corrigida }}"
          echo "ğŸ§ª Extraindo ID do artefato..."
          ID=$(echo "$URL" | grep -oP 'artifacts/\K[0-9]+')

          if [[ -n "$ID" ]]; then
            echo "ğŸ—‘ï¸ Deletando artefato ID: $ID de Miraplay2025/Live..."
            curl -X DELETE \
              -H "Authorization: Bearer $PERSONAL_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/Miraplay2025/Live/actions/artifacts/$ID" \
              -w "\nâœ… Artefato excluÃ­do com status: %{http_code}\n"
          else
            echo "âš ï¸ NÃ£o foi possÃ­vel extrair o ID do artefato. Nenhuma exclusÃ£o feita."
          fi
